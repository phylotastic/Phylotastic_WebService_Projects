import pymongo
import datetime 
import json
from bson import json_util
from bson.json_util import dumps

dbName = "SpeciesList"
dataCollectionName ="userSpecieslist"
counterCollectionName = "listCounters"

#connection to Mongo DB
def connect_mongodb(host='localhost', port=27017):
 	try:
 		conn=pymongo.MongoClient(host, port)
 		print "Connected successfully!!!"
 	except pymongo.errors.ConnectionFailure, e:
 		print "Could not connect to MongoDB: %s" % e 

 	return conn

#-------------------------------------
#get lists of a user from the database
def get_user_lists(user_id, conn, include_all):
  	db = conn[dbName]
 	data_collection = db[dataCollectionName]
 	document = data_collection.find({"user_id":user_id},{"lists" : 1});	
  	
 	if document.count() == 0:
 		message = "No user found"
  		status_code = 204  #The server successfully processed the request and is not returning any content	
 	else:
 		message = "Success"
 		status_code = 200
 	
 	user_lists_obj = []
 	user_lists = []
 	for ulist in document:
  		lists = ulist['lists'] 				
 		for list_obj in lists:
  			list_json = {}
 			list_short_json = {} 
  			
 			list_json['list_id'] = list_obj['list_id']			
  			list_short_json['list_id'] = list_obj['list_id']
			
 			list_json['list_title'] = list_obj['title']  		 	
 			list_short_json['list_title'] = list_obj['title']
 			
 			list_json['list_description'] = list_obj['description']
 			list_json['list_date_published'] = list_obj['date_published'].strftime("%m-%d-%Y")
 			list_json['list_author'] = list_obj['list_author']
  			list_json['list_curator'] = list_obj['curator']			
 			list_json['list_curation_date'] = list_obj['curation_date'].strftime("%m-%d-%Y")
 			list_json['list_source'] = list_obj['source']
 			list_json['list_keywords'] = list_obj['keywords']
 			list_json['list_focal_clade'] = list_obj['focal_clade']
 			list_json['list_extra_info'] = list_obj['extra_info']
 		 	
 			user_lists_obj.append(list_json)
 			user_lists.append(list_short_json)
 
 	if include_all:
 	 	return json.dumps({"user_id": user_id, 'lists': user_lists_obj, "message": message, "status_code": status_code})
 	else:
 		return json.dumps({"user_id": user_id, 'lists': user_lists, "message": message, "status_code": status_code})

#-----------------------------------------
#get species of a list of a particular user from the database
def get_user_list_species(user_id, list_id, conn, include_all):
 	db = conn[dbName]
 	data_collection = db[dataCollectionName]	
 	document = data_collection.find({"user_id":user_id},{"lists" : 1});
 	
 	if document.count() == 0:
 		message = "No user found"
 		status_code = 204  #The server successfully processed the request and is not returning any content
 	else:
 		message = "Success"
  	 	status_code = 200

 	found_list = False	
 	species_list_obj = []
 	species_list = []
 	for ulist in document:
  		lists = ulist['lists'] 				
 		for list_obj in lists:
 			if list_obj['list_id'] == list_id: 			
				found_list = True	 			
 				sp_lst = list_obj['species']
 				for species_obj in sp_lst:
 				 	species_json = {}
	  			 	species_json['vernacular_name'] = species_obj['vernacular_name']
			 		species_json['scientific_name'] = species_obj['scientific_name']  		 	
	 			 	species_json['scientific_name_authorship'] = species_obj['scientific_name_authorship']
 					species_json['family'] = species_obj['family']
 					species_json['order'] = species_obj['order']
 					species_json['phylum'] = species_obj['phylum']
 					species_json['nomenclature_code'] = species_obj['nomenclature_code']
 	 				species_list_obj.append(species_json)
 					#only the scientific names of species 
 					species_list.append(species_obj['scientific_name']) 
 	
 	if found_list == False:
 		message = "Invalid List ID"
 	 	status_code = 404 #The requested resource could not be found but may be available again in the future

 	if include_all:
 		return json.dumps({"user_id": user_id, "list_id": list_id, "species": species_list_obj, "message": message, "status_code": status_code})
 	else:
 		return json.dumps({"user_id": user_id, "list_id": list_id, "species": species_list, "message": message, "status_code": status_code}) 
	
#---------------------------------------------------------------
#insert lists into the database
def insert_user_lists(list_info, conn):
 	db = conn[dbName]
 	data_collection = db[dataCollectionName]
 	counter_collection = db[counterCollectionName]
 	
 	list_info_json = json.loads(list_info)
  	user_id =  list_info_json["user_id"]
 	user_name = list_info_json["user_name"]	
 	
 	sequence = "list_id_" + str(user_id)

 	user_found = False
 	document = data_collection.find({"user_id":user_id})
 	if document.count() == 0:
 		#new user
 		createNewSequence(counter_collection, sequence)
 	else:
 		#exsiting user
 		user_found = True

 	list_id = getNextSequence(counter_collection, sequence)
  	list_mgdb_obj = create_list_mgdb_obj(json.dumps(list_info_json['list']), list_id)	
 	
 	status = False
 	if user_found:
 	 	status = data_collection.update({"user_id":user_id},{"$push":{"lists":list_mgdb_obj}})
  		#status_json = json.loads(update_status)
 		#status = status_json['updatedExisting']
 	else:	
 	 	document = { "user_id": user_id, "user_name": user_name, "lists":[list_mgdb_obj] }
 	 	status = data_collection.insert(document)
 	 	#if insert_status != None:
 		#	status = True
 	
 	if status != None:
 		return json.dumps({"message": "Success", "status_code": 200})
 	else:
 		return json.dumps({"message": "Error inserting document", "status_code": 500})
 	
#--------------------------------------
#create list object to store in mongodb 
def create_list_mgdb_obj(list_info, list_id):
 	list_json = json.loads(list_info)
  	
 	date_published_str = list_json['list_date_published']	
 	date_published_obj = datetime.datetime.strptime(date_published_str, "%m-%d-%Y")
  	#date_published_obj = datetime.datetime(2009, 11, 12)
 	curation_date_str = list_json['list_curation_date']	
 	curation_date_obj = datetime.datetime.strptime(curation_date_str, "%m-%d-%Y")
 	#curation_date_obj = datetime.datetime(2010, 11, 12)

 	list_mgdb_obj = {"list_id": list_id,
         "title": list_json['list_title'],
         "description": list_json['list_description'],
         "list_author": list_json['list_author'],
         "date_published": date_published_obj,
         "curator": list_json['list_curator'],
         "curation_date": curation_date_obj,
         "source": list_json['list_source'],		
         "keywords": list_json['list_keywords'],
         "focal_clade": list_json['list_focal_clade'],
         "extra_info": list_json['list_extra_info'],
         "is_public": list_json['is_public'],
	 	 "species": list_json['species']
 	}
 	#print list_mgdb_obj
 	return list_mgdb_obj

#----------------------------------------------------
#create a sequence for the list_id (in 'counters' collection)
def	createNewSequence(collection, seq_name): 
 	collection.insert({'_id': seq_name, 'seq': 0})  

#------------------------------------------------------
#get next list_id
def getNextSequence(collection, seq_name):   
 	return collection.find_and_modify(query= { '_id': seq_name },update= { '$inc': {'seq': 1}}, new=True ).get('seq');  

#--------------------------------------------------------------

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
if __name__ == "__main__":
 	conn = connect_mongodb()
 	#collection = get_database_collection(conn, 'species_list', 'UserListSpecies')
 	#print get_user_list_species(1234, 2, collection)
 	#print get_user_lists(1233, collection)
  	input_json = json.dumps({ 'user_id': 2, 'user_name': "hdail.laughinghouse@gmail.com",
   				 'list': {
       				 	'list_title': "210 native orchid species of the US, Canada and Greenland",
       					'list_description': "List of orchid species with metadata on conservation rank,red list status,  and number of botanical gardens present",
       					'list_author': ["G. Krupnick", "M. McCormick", "T. Mirenda", "D. Whigham"],
       					'list_date_published': "12-13-2013",
       					'list_curator': "HD Laughinghouse",
       					'list_curation_date': "2-24-2016",
       					'list_source': "Krupnick et al. (2013). Ann. Missouri Bot. Gard 99: 180-198",
       					'list_keywords': [
         					"Red list",
         					"endangered species",
 							"orchids",
 							"Canada",
 							"USA"
       					],
       					'list_focal_clade': "Orchidaceae",
       					'list_extra_info': "",
       					'is_public': False,
       					'species': [{"family": "", "scientific_name": "Platanthera praeclara", "scientific_name_authorship": "Sheviak et M.L. Bowles", "vernacular_name": "", "phylum": "Streptophyta", "nomenclature_code": "ICN", "order": ""}, {"family": "", "scientific_name": "Vanilla inodora", "scientific_name_authorship": "Schiede", "vernacular_name": "", "phylum": "Streptophyta", "nomenclature_code": "ICN", "order": ""}, {"family": "", "scientific_name": "Spiranthes infernalis", "scientific_name_authorship": "Sheviak", "vernacular_name": "", "phylum": "Streptophyta", "nomenclature_code": "ICN", "order": ""}, {"family": "", "scientific_name": "Ponthieva racemosa", "scientific_name_authorship": "(Walter) C. Mohr", "vernacular_name": "", "phylum": "Streptophyta", "nomenclature_code": "ICN", "order": ""}, {"family": "", "scientific_name": "Tipularia discolor", "scientific_name_authorship": "(Pursh) Nutt", "vernacular_name": "", "phylum": "Streptophyta", "nomenclature_code": "ICN", "order": ""}, {"family": "", "scientific_name": "Cranichus muscosa", "scientific_name_authorship": "Sw.", "vernacular_name": "", "phylum": "Streptophyta", "nomenclature_code": "ICN", "order": ""}]
 			}
 	})	
 	#print input_json
 	#prepare_list_mongodb_obj(json.dumps({"date_published": "11-08-2011"}))
 	#print insert_user_lists(input_json, conn)
 	print get_user_lists(159, conn, True)
 	#print get_user_list_species(159, 4, conn)
